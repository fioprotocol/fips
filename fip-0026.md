---
fip: 26
title: FIO Domain Marketplace
status: Draft
type: Functionality
author: Isaiah Williams - EOS BlockSmith, Thomas Le - EOS BlockSmith
created: 2021-02-05
updated: 2021-03-29
---

# Abstract
What we are planning to create is a marketplace where users can buy and sell FIO Domains.  Users will interact with the frontend website to view and place domains up for sale.  The frontend will interact with the FIO Escrow Smart Contract to facilitate transactions between users who buy and sell domains.

### Proposed new actions:

|Contract|Action|Endpoint|Description|
|---|---|---|---|
|fio.escrow|listdomain|list_domain|User puts domain up for sale|
|fio.escrow|cxlistdomain|cancel_list_domain|Seller of domain decides not to sell and cancels their listing|
|fio.escrow|buydomain|buy_domain|User buys a domain that is up for sale|
|fio.escrow|setmrkplcfg|set_marketplace_config|The `mrkplconfig` table holds configs for a given marketplace. This action writes to that table.|
|fio.escrow|rmmrkplcfg|remove_marketplace_config|Removes a marketplace from the `mrkplconfig` table|
|fio.escrow|setmkpcomfee|set_marketplace_commission_fee|Sets the marketplace commission fee in the `mrkplconfig` table|
|fio.escrow|setmkplstfee|set_marketplace_listing_fee|Sets the marketplace listing fee in the `mrkplconfig` table|
|fio.escrow|sethldacct|set_holder_account|Sets holder account public key to the `holderacct` table|
|fio.address|xferescrow| none |Transfers domain to `holderacct`. Called from fio.escrow only|

## Modified actions
|Contract|Action|Endpoint|Description|
|---|---|---|---|
|fio.token|transfer|none|Transfer FIO from within smart contracts|
|fio.address|burnexpired|none|Burns domains and addresses on that domain|
|fio.treasury|bprewdupdate| ? | added `EscrowContract` to authorization list|
|fio.treasury|bppoolupdate| ? | added `EscrowContract` to authorization list|
|fio.treasury|fdtnrwdupdat| ? | added `EscrowContract` to authorization list|

# Terminology
* **Listing** - a domain that is up for sale
* **FIO Domain Marketplace** - the frontend website
* **Seller** - the seller of a domain
* **Buyer** - the buyer of a domain
* **Listing Fee** - fee paid to the marketplace from the seller to the marketplace. Flat fee in FIO.
* **Commission Fee** - fee paid to the marketplace when a domain is sold. This is a percentage of the sale price.
* **Holder Account** - This is the account that is designated to hold ownership of domains while they are listed for sale. This is set by the BPs via msig and secured in such a way that no one person has access to the account and can transfer the domains away.
* **Marketplace (Account)** - the account owned by the entity running the front end that interacts with this contract


# Motivation
There does not currently exist a platform for buying, selling, and trading FIO Domains.  As the popularity of FIO grows, the likelihood of a desired domain being available decreases.  It is also common for individuals to purchase names of popular name brands in order to later sell the domain to the company who owns the brand (name squatting).  Without a marketplace for domains to be sold, these transactions become difficult.  By providing ease of use solutions to name and address transactions, a marketplace also increases the revenue flow of block producers by increasing the amount of fees generated by each transaction.

# Specification

## Core Concept
Users will interact with the frontend website to view and place domains up for sale.  The frontend will interact with the FIO Escrow Smart Contract to facilitate transactions between users who buy and sell domains.  The diagram below displays how the user, the website, the smart contract and the account that owns the smart contract all work together.

![Image of UML Diagram](https://github.com/iwill610/FDM_UMLsd/blob/main/FIO%20Domain%20Marketplace.png)

This diagram reads left to right and top to bottom.  There are three different scenarios outlined and they are distinguished by the color of the arrows.  The first scenario, in red, starts will the user using the website to place a domain up for sale for a specified price.  This user is denoted as "seller."  To initiate this scenario, the seller will pay a listing fee to list their domain for sale on the marketplace.  The "Marketplace" shown in this diagram is the account owned by the entity running the front end that interacts with this contract.  The website then communicates that the smart contract needs to use the "listdomain" action, which will transfer ownership of the domain to a “holder account” and place that domain for sale on the website.  The holder_account is a designated account to be the intermediary that will hold the domain while listed.

The second scenario, in blue, starts will the seller canceling their listing on the website.  The website then communicates with the smart contract in order to transfer ownership of the domain from the holder account back to the seller. 

The last scenario, in green, starts with a different user buying a listing on the website.  This second user is denoted as "buyer."  The website then communicates with the smart contract in order to transfer ownership of the address to the buyer and transfer the funds used to buy the domain to the seller.  The marketplace will take a commission for facilitating this transaction.

## New Tables

### Listing table

#### domainsale
Holds all the domains currently available for sale with related information like the owner and amount of FIO the user wants.

We are saving the commission fee per domain listing because the commission fee can be changed but for existing listings it should not change because they agreed to list with a certain commission fee. 

|Column|Type|Description|
|---|---|---|
|id|uint64|Primary key|
|owner|uint64|actor of owners account|
|ownerhash|uint128|hashed value of `owner`
|domain|string|name of domain for sale|
|domainhash|uint128|hashed value of `domain`|
|marketplace|string|name of marketplace used to list domain|
|marketplacehash|uint128|hashed value of `marketplace`|
|sale_price|int64|sale price in SUF| 
|commission_fee|int64|commission fee applied to sale price|

##### Indexes
- Primary Key
- bydomain
- byowner
- bymarketplace

### Marketplace Config Table

#### mrkplconfig
Holds information related to the marketplace.

|Column|Type|Description|
|---|---|---|
|id|uint64|Primary key|
|marketplace|string|name of marketplace used to list domain|
|marketplacehash|uint128|hashed value of `marketplace`|
|owner|uint64|actor of owners account|
|ownerhash|uint128|hashed value of `owner`|
|owner_public_key|string|public key of owners account|
|commission_fee|uint64|Commission fee is a percentage taken out of the sale price when a domain is sold|
|listing_fee|uint64|Listing fee is taken up front for creating a listing|
|e_break|uint64|This is a setting that will disable all actions in the event of a major exploit or bug found to mitigate damages|

#### Indexes
- primary key
- bymarketplace
- byowner

### Holder Account Table

#### holderacct
Holds the public key of the account that will be used to hold all the domains while they are on sale. This table will only ever have 1 entry.

|Column|Type|Description|
|---|---|---|
|id|uint64|Primary key|
|holder_public_key|string|public key of the holder account|

#### Indexes
- primary key

## New actions

### List Domain for Sale
This action will post the domain up for sale on the marketplace for a specified price. A listing fee is collected from the domain owner for this action that goes to the marketplace. This will also transfer the domain ownership to the escrow holder account
#### Contract: fio.escrow
#### New fee: list_domain, not bundle eligible
#### New Endpoint: list_domain
#### Ram Increase: To be determined during implementation
#### New action: *listdomain*
#### Request body
|Parameter|Required|Format|Definition|
|---|---|---|---|
|actor|Yes|12 character string|Valid actor of signer (seller)|
|fio_domain|Yes|FIO Domain|Valid and FIO Domain that does not expire within the next 90 days|
|sale_price|Yes|Positive Int|The amount of SUFs for which the seller wants to sell their domain|
|max_fee|Yes|Positive Int|Maximum amount of SUFs the user is willing to pay for fee. Should be preceded by [/get_fee](https://developers.fioprotocol.io/api/api-spec/reference/get-fee/get-fee) for correct value.|
|tpid|Yes|FIO Address|FIO Address of the entity which generates this transaction. TPID rewards will be paid to this address. Set to empty if not known.|

##### Example
```
{
    "actor": "2odzomo2v4pe"
    "fio_domain": "alice",
    "sale_price": 20000000000,
    "max_fee": 1000000000,
    "tpid": "rewards@wallet"
}
```
#### Processing
- Request is validated per exception handling
- Hash both the `actor`, `fio_domain`, `marketplace` to store along side the string, for indexing.
- Retrieve current `commission_fee` from the marketplace config table to be saved with the listing
- Add domain to the `domainsale` table with relevant information
- Transfer domain from seller to the holder account public key.
- A listing fee is collected by the marketplace and is set in the marketplace config table
- Verify tx does not exceed max transaction size.

#### Exception handling
|Error condition|Trigger|Type|fields:name|fields:value|Error message|
|---|---|---|---|---|---|
|Invalid marketplace|Supplied `marketplace` is not found in marketplace config table `mrkplconfig`|400|"marketplace"|Value sent in, e.g. "notamarketplace"|"Marketplace not found"|
|Invalid sale price|Supplied `sale_price` (in SUF) is not greater than 1|400|"sale_price"|Value sent in, e.g. "1000000000"|"Sale price must be greater than 1"|
|Invalid fee value|max_fee format is not valid|400|"max_fee"|Value sent in, e.g. "-100"|"Invalid fee value"|
|Fee exceeds maximum|Actual fee is greater than supplied max_fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Fee exceeds supplied maximum"|
|Invalid TPID|tpid format is not valid|400|"tpid"|Value sent in, e.g. "notvalidfioaddress"|"TPID must be empty or valid FIO address"|
|Invalid FIO domain|Supplied `fio_domain` is not listed for sale.|400|"fio_domain"|Value sent in, e.g. "alice"|"FIO domain not found"|
|Invalid FIO Domain format|FIO Domain format is not valid|400|"fio_domain"|Value sent in, e.g. "alice"|"Invalid FIO domain"|
|FIO Domain expired|FIO Domain is expired|400|"fio_domain"|Value sent in, e.g. "alice"|"FIO Domain expired. Renew first."|
|FIO Domain not registered|FIO Domain is not registered|400|"fio_domain"|Value sent in, e.g. "alice"|"FIO Domain not registered"|
|Not owner of FIO Domain|The signer does not own the domain|403||||
|Actor not signer|The signer and the `actor` do not match |403| | |Type: invalid_signature|

#### Response Body
|Parameter|Format|Definition|
|---|---|---|
|status|String|OK if successful|
|listing_id|Int|id of the listing|
|fee_collected|Int|Amount of SUFs collected as fee|

##### Example
```
{
  "status": "OK",
  "listing_id": 1
  "fee_collected": 2000000000
}
```

### Cancel Domain Listing
This action will take the domain off of the marketplace and return ownership of the domain to the seller.

#### New action: *cxlistdomain*
#### Contract: fio.escrow
#### New fee: cancel_list_domain, not bundle eligible
#### New Endpoint: cancel_list_domain
#### Ram Increase: To be determined during implementation

#### Request
|Parameter|Required|Format|Definition|
|---|---|---|---|
|fio_domain|Yes|FIO Domain|Valid and unexpired FIO Domain|
|actor|Yes|12 character string|Valid actor of signer (seller)|
|max_fee|Yes|Positive Int|Maximum amount of SUFs the user is willing to pay for fee. Should be preceded by [/get_fee](https://developers.fioprotocol.io/api/api-spec/reference/get-fee/get-fee) for correct value.|
|tpid|Yes|FIO Address|FIO Address of the entity which generates this transaction. TPID rewards will be paid to this address. Set to empty if not known.|

##### Example
```
{
    "actor": "2odzomo2v4pe",
    "fio_domain": "alice",
    "max_fee": 1000000000,
    "tpid": "rewards@wallet"
}
```
#### Processing
- Request is validated per exception handling
- Remove listing from the `domainsale` table
- Transfer domain from holder account to actor
- Verify that the fee for this does not exceed the max fee specified.
- Charge appropriate fee (this will be a bundled fee transaction, fee will be same as reject)
- Verify tx does not exceed max transaction size.

#### Exception handling
|Error condition|Trigger|Type|fields:name|fields:value|Error message|
|---|---|---|---|---|---|
|Invalid FIO Domain format|FIO Domain format is not valid|400|"fio_domain"|Value sent in, e.g. "alice"|"Invalid FIO domain"|
|FIO Domain expired|FIO Domain is expired|400|"fio_domain"|Value sent in, e.g. "alice"|"FIO Domain expired. Renew first."|
|FIO Domain not registered|FIO Domain is not registered|400|"fio_domain"|Value sent in, e.g. "alice"|"FIO Domain not registered"|
|FIO Domain listing not found|Supplied `fio_domain` is not listed on `domainsale` table.|400|"fio_domain"|Value sent in, e.g. "alice"|"FIO domain not listed in `domainsale` table"|
|Invalid fee value|max_fee format is not valid|400|"max_fee"|Value sent in, e.g. "-100"|"Invalid fee value"|
|Fee exceeds maximum|Actual fee is greater than supplied max_fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Fee exceeds supplied maximum"|
|Insufficient funds to cover fee|Account does not have enough funds to cover fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Insufficient funds to cover fee"|
|Invalid TPID|tpid format is not valid|400|"tpid"|Value sent in, e.g. "notvalidfioaddress"|"TPID must be empty or valid FIO address"|
|Not owner of FIO Domain|The signer does not own the domain|403| | | |
|Actor not signer|The signer and the `actor` do not match |403| | |Type: invalid_signature|

#### Response body
|Parameter|Format|Definition|
|---|---|---|
|status|String|OK if successful|
|fee_collected|Int|Amount of SUFs collected as fee|

##### Example
```
{
  "status": "OK",
  "fee_collected": 2000000000
}
```

### Buy Domain Listing
This action will collect the FIO from the buyer, transfer the domain from holder account to the buyer, and transfer the sale price, minus commission fee to the marketplace, to the seller.

#### New action: *buydomain*
#### Contract: fio.escrow
#### New fee: buy_domain, not bundle eligible
#### New Endpoint: buy_domain
#### Ram Increase: To be determined during implementation
#### Request
|Parameter|Required|Format|Definition|
|---|---|---|---|
|actor|Yes|12 character string|Valid actor of signer (buyer)|
|sale_id|Yes|Positive Int|Primary key of the record in the `domainsale` table.|
|fio_domain|Yes|FIO Domain|Domain that can be found on the `domainsale` table.|
|buy_price|Yes|Positive Int|Amount of FIO, in SUFs, that the buyer expects to pay|
|max_fee|Yes|Positive Int|Maximum amount of SUFs the user is willing to pay for fee. Should be preceded by [/get_fee](https://developers.fioprotocol.io/api/api-spec/reference/get-fee/get-fee) for correct value.|
|tpid|Yes|FIO Address|FIO Address of the entity which generates this transaction. TPID rewards will be paid to this address. Set to empty if not known.|

##### Example
```
{
    "actor": "2odzomo2v4pe",
    "sale_id": 1
    "fio_domain": "alice",
    "buy_price": 100000000000,
    "max_fee": 1000000000,
    "tpid": "rewards@wallet"
}
```
#### Processing
- Request is validated per exception handling
- Calculate commission to marketplace
- Send, from buyer, commission fee sent to marketplace owner
- Send, from buyer, rest of sell price to the domain seller
- Transfer domain from holder account to buyer.
- Verify that the fee for this does not exceed the max fee specified.
- Charge appropriate fee (this will be a bundled fee transaction, fee will be same as reject)
- verify tx does not exceed max transaction size.

#### Exception handling
|Error condition|Trigger|Type|fields:name|fields:value|Error message|
|---|---|---|---|---|---|
|FIO Domain listing not found|Supplied `fio_domain` is not listed on `domainsale` table.|400|"fio_domain"|Value sent in, e.g. "alice"|"FIO domain not listed in `domainsale` table"|
|Invalid FIO Domain format|FIO Domain format is not valid|400|"fio_domain"|Value sent in, e.g. "alice"|"Invalid FIO domain"|
|FIO Domain expired|FIO Domain is expired|400|"fio_domain"|Value sent in, e.g. "alice"|"FIO Domain expired. Renew first."|
|FIO Domain not registered|FIO Domain is not registered|400|"fio_domain"|Value sent in, e.g. "alice"|"FIO Domain not registered"|
|Insufficient Funds|`buyer` doesn't have enough funds|400|"buy_price"|Value sent in, e.g. "1000000000"|"Not enough FIO"|
|Invalid fee value|max_fee format is not valid|400|"max_fee"|Value sent in, e.g. "-100"|"Invalid fee value"|
|Fee exceeds maximum|Actual fee is greater than supplied max_fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Fee exceeds supplied maximum"|
|Insufficient funds to cover fee|Account does not have enough funds to cover fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Insufficient funds to cover fee"|
|Invalid TPID|tpid format is not valid|400|"tpid"|Value sent in, e.g. "notvalidfioaddress"|"TPID must be empty or valid FIO address"|
|Sale Price exceeds buy_price parameter|Actual sale price of domain exceeds the buy_price supplied|400|"buy_price"|Value sent in, e.g. "100000000"|"sale price exceeds supplied buy price"|
|Not owner of FIO Domain|The signer does not own the domain|403||||
|Actor not signer|The signer and the `actor` do not match |403| | |Type: invalid_signature|

#### Response body
|Parameter|Format|Definition|
|---|---|---|
|status|String|OK if successful|
|buy_price|Int|Amount of SUFs collected for buy_price|
|fee_collected|Int|Amount of SUFs collected as fee|

##### Example
```
{
  "status": "OK",  
  "buy_price": 100000000000,
  "fee_collected": 2000000000
}
```

### Set Holder Account
#### Contract: fio.escrow
#### New fee: set_holder_account, not bundle eligible
#### New Endpoint: set_holder_account
#### Ram Increase: To be determined during implementation
#### New action: *sethldacct*
This can only be called from the **EscrowContract** or a **SystemAccount**. It will be set once and likely will never need to be changed.

#### Request
|Parameter|Required|Format|Definition|
|---|---|---|---|
|public_key|Yes|string|Valid FIO public key of an actor registered on FIO|
|max_fee|Yes|Positive Int|Maximum amount of SUFs the user is willing to pay for fee. Should be preceded by [/get_fee](https://developers.fioprotocol.io/api/api-spec/reference/get-fee/get-fee) for correct value.|
|tpid|Yes|FIO Address|FIO Address of the entity which generates this transaction. TPID rewards will be paid to this address. Set to empty if not known.|
|actor|Yes|FIO account|Name of account to pay fee|

##### Example
```
{
    "public_key": "FIO7VND52g9gwoahPAbA7gLosbpNY4uKsqy6qFUJysw8gSG15QXWC",
    "max_fee": 1000000000,
    "tpid": "rewards@wallet"
}
```
#### Processing
- Request is validated per exception handling
- Write key to 0th index in the table since there will only ever be one key.
- Verify that the fee for this does not exceed the max fee specified.
- Charge appropriate fee (this will be a bundled fee transaction, fee will be same as reject)
- Verify tx does not exceed max transaction size.

#### Exception handling
|Error condition|Trigger|Type|fields:name|fields:value|Error message|
|---|---|---|---|---|---|
|Invalid public key|Invalid FIO Public Key|400|"public_key"|Value sent in, e.g."FIOinValidKey1234232"|"Invalid Public Key"|
|Invalid fee value|max_fee format is not valid|400|"max_fee"|Value sent in, e.g. "-100"|"Invalid fee value"|
|Fee exceeds maximum|Actual fee is greater than supplied max_fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Fee exceeds supplied maximum"|
|Insufficient funds to cover fee|Account does not have enough funds to cover fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Insufficient funds to cover fee"|
|Invalid TPID|tpid format is not valid|400|"tpid"|Value sent in, e.g. "notvalidfioaddress"|"TPID must be empty or valid FIO address"|
|EscrowContract or SystemAccount not signer|Any signer other than EscrowContract or SystemAccount|403| | |Type: invalid_signature|

#### Response body
|Parameter|Format|Definition|
|---|---|---|
|status|String|OK if successful|
|fee_collected|Int|Amount of SUFs collected as fee|

##### Example
```
{
  "status": "OK",
  "fee_collected": 2000000000
}
```

### Set Marketplace Config
#### Contract: fio.escrow
#### New fee: set_marketplace_config, not bundle eligible
#### New Endpoint: set_marketplace_config
#### Ram Increase: To be determined during implementation
#### New action: *setmrkplcfg*
This sets the marketplace configurations. 

This should only have to be called once unless the marketplace is removed for some reason. It can only be called via msig by the BPs.

#### Request
|Parameter|Required|Format|Definition|
|---|---|---|---|
|marketplace|Yes|string 20 characters max|Name of marketplace|
|owner|Yes|12 character string|Valid actor of signer|
|owner_public_key|Yes|FIO Public Address|Valid public key of owner|
|commissionfee|Yes|Number 0-25|Used to calculate commission fee from sale price|
|listingfee|Yes|Number less than 10|Flat fee in FIO taken up front for listing a domain for sale|
|max_fee|Yes|Positive Int|Maximum amount of SUFs the user is willing to pay for fee. Should be preceded by [/get_fee](https://developers.fioprotocol.io/api/api-spec/reference/get-fee/get-fee) for correct value.|
|tpid|Yes|FIO Address|FIO Address of the entity which generates this transaction. TPID rewards will be paid to this address. Set to empty if not known.|
|actor|Yes|FIO account|Name of account to pay fee|

##### Example
```
{
    "marketplace": "somemarketplace",
    "owner": "iooogn5hrutc",
    "owner_public_key": "FIO6TJcqTGShkALUSdAyW4rhRt1kjgz5PuVUyf4pmaEEeb7VtCRy3",
    "comissionfee": "6",
    "listingfee": "3",
    "e_break": 0,
    "max_fee": 1000000000,
    "tpid": "rewards@wallet",
    "actor": "rampayer"
}
```
#### Processing
- Request is validated per exception handling
- Write data to marketplace config table
- Verify that the fee for this does not exceed the max fee specified.
- Charge appropriate fee (this will be a bundled fee transaction, fee will be same as reject)
- Verify tx does not exceed max transaction size.

#### Exception handling
|Error condition|Trigger|Type|fields:name|fields:value|Error message|
|---|---|---|---|---|---|
|Invalid marketplace name|Supplied `marketplace` name is not between 1 and 25 characters|400|"marketplace"|empty string, "", "areallylongmarketplacename" |"Length of marketplace name should be between 1 and 25 characters"|
|Invalid actor name|Supplied `owner` is not a registered actor on FIO.|400|"owner"| |"Account not registered on FIO"|
|Invalid public key|Invalid FIO Public Key|400|"owner_public_key"|Value sent in, e.g."FIOinValidKey1234232"|"Invalid Public Key"|
|Invalid commission fee|`commissionfee` is not between 0-25|400|"comissionfee"|Value sent in, e.g. "50" |"Commission fee can only be between 0 and 25"|
|Invalid listing fee|`listingfee` is not between 0-10|400|"listingfee"|Value sent in, e.g. "20" |"Listing fee can only be between 0 and 10"|
|Invalid fee value|max_fee format is not valid|400|"max_fee"|Value sent in, e.g. "-100"|"Invalid fee value"|
|Fee exceeds maximum|Actual fee is greater than supplied max_fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Fee exceeds supplied maximum"|
|Insufficient funds to cover fee|Account does not have enough funds to cover fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Insufficient funds to cover fee"|
|Invalid TPID|tpid format is not valid|400|"tpid"|Value sent in, e.g. "notvalidfioaddress"|"TPID must be empty or valid FIO address"|
|Actor not signer|The signer and the `actor` do not match |403| | |Type: invalid_signature|

#### Response body
|Parameter|Format|Definition|
|---|---|---|
|status|String|OK if successful|
|fee_collected|Int|Amount of SUFs collected as fee|

##### Example
```
{
  "status": "OK",
  "fee_collected": 2000000000
}
```
### Remove Marketplace Config
#### Contract: fio.escrow
#### New fee: remove_marketplace_config, not bundle eligible
#### New Endpoint: remove_marketplace_config
#### Ram Increase: To be determined during implementation
#### New action: *rmmrkplcfg*
This removes a marketplace configuration. 

This can only be called by the BPs via msig. 

#### Request
|Parameter|Required|Format|Definition|
|---|---|---|---|
|actor|Yes|12 character string|Valid actor of signer |
|marketplace|Yes|1-25 character string|Valid, registered marketplace|
|max_fee|Yes|Positive Int|Maximum amount of SUFs the user is willing to pay for fee. Should be preceded by [/get_fee](https://developers.fioprotocol.io/api/api-spec/reference/get-fee/get-fee) for correct value.|
|tpid|Yes|FIO Address|FIO Address of the entity which generates this transaction. TPID rewards will be paid to this address. Set to empty if not known.|

##### Example
```
{
    "actor": "2odzomo2v4pe",
    "marketplace": "marketplace",
    "max_fee": 1000000000,
    "tpid": "rewards@wallet"
}
```
#### Processing
- Request is validated per exception handling
- Remove marketplace from table
- Verify that the fee for this does not exceed the max fee specified.
- Charge appropriate fee (this will be a bundled fee transaction, fee will be same as reject)
- Verify tx does not exceed max transaction size.

#### Exception handling
|Error condition|Trigger|Type|fields:name|fields:value|Error message|
|---|---|---|---|---|---|
|Invalid marketplace|Supplied `marketplace` is not found in marketplace config table `mrkplconfig`|400|"marketplace"|Value sent in, e.g. "notamarketplace"|"Marketplace not found"|
|Invalid fee value|max_fee format is not valid|400|"max_fee"|Value sent in, e.g. "-100"|"Invalid fee value"|
|Fee exceeds maximum|Actual fee is greater than supplied max_fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Fee exceeds supplied maximum"|
|Insufficient funds to cover fee|Account does not have enough funds to cover fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Insufficient funds to cover fee"|
|Invalid TPID|tpid format is not valid|400|"tpid"|Value sent in, e.g. "notvalidfioaddress"|"TPID must be empty or valid FIO address"|
|Actor not signer|The signer and the `actor` do not match |403| | |Type: invalid_signature|

#### Response body
|Parameter|Format|Definition|
|---|---|---|
|status|String|OK if successful|
|fee_collected|Int|Amount of SUFs collected as fee|

##### Example
```
{
  "status": "OK",
  "fee_collected": 2000000000
}
```

### Set Commission Fee
#### Contract: fio.escrow
#### New fee: set_marketplace_commission_fee, not bundle eligible
#### New Endpoint: set_marketplace_commission_fee
#### Ram Increase: To be determined during implementation
#### New action: *setmkpcomfee*
This sets the commission fee given to the marketplace. Only can be changed by marketplace and BPs 

The current commission fee is stored on each listing so that if the commission fee changes the current listings are not affected. 

#### Request
|Parameter|Required|Format|Definition|
|---|---|---|---|
|actor|Yes|12 character string|Valid actor of signer (buyer)|
|fee|Yes|Number 0-25|Used to calculate commission fee from sale price.|
|max_fee|Yes|Positive Int|Maximum amount of SUFs the user is willing to pay for fee. Should be preceded by [/get_fee](https://developers.fioprotocol.io/api/api-spec/reference/get-fee/get-fee) for correct value.|
|tpid|Yes|FIO Address|FIO Address of the entity which generates this transaction. TPID rewards will be paid to this address. Set to empty if not known.|

##### Example
```
{
    "actor": "2odzomo2v4pe",
    "fee": "3",
    "max_fee": 1000000000,
    "tpid": "rewards@wallet"
}
```
#### Processing
- Request is validated per exception handling
- Find marketplace
- Modify commission fee
- Verify that the fee for this does not exceed the max fee specified.
- Charge appropriate fee (this will be a bundled fee transaction, fee will be same as reject)
- Verify tx does not exceed max transaction size.

#### Exception handling
|Error condition|Trigger|Type|fields:name|fields:value|Error message|
|---|---|---|---|---|---|
|Invalid marketplace|Supplied `marketplace` is not found in marketplace config table `mrkplconfig`|400|"marketplace"|Value sent in, e.g. "notamarketplace" |"Marketplace not found"|
|Invalid commission fee|`fee` is not between 0-25|400|"fee"|Value sent in, e.g. "50" |"Commission fee can only be between 0 and 25"|
|Invalid fee value|max_fee format is not valid|400|"max_fee"|Value sent in, e.g. "-100"|"Invalid fee value"|
|Fee exceeds maximum|Actual fee is greater than supplied max_fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Fee exceeds supplied maximum"|
|Insufficient funds to cover fee|Account does not have enough funds to cover fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Insufficient funds to cover fee"|
|Invalid TPID|tpid format is not valid|400|"tpid"|Value sent in, e.g. "notvalidfioaddress"|"TPID must be empty or valid FIO address"|
|Actor not signer|The signer and the `actor` do not match |403| | |Type: invalid_signature|
|Not owner of marketplace|The signer does not own the marketplace|403| | | |

#### Response
|Parameter|Format|Definition|
|---|---|---|
|status|String|OK if successful|
|fee_collected|Int|Amount of SUFs collected as fee|

##### Example
```
{
  "status": "OK",
  "fee_collected": 2000000000
}
```

### Set Listing Fee
#### Contract: fio.escrow
#### New fee: set_marketplace_listing_fee, not bundle eligible
#### New Endpoint: set_marketplace_listing_fee
#### Ram Increase: To be determined during implementation
#### New action: *setmkplstfee*
This sets the listing fee given to the marketplace. Only can be changed by marketplace and BPs

#### Request
|Parameter|Required|Format|Definition|
|---|---|---|---|
|actor|Yes|12 character string|Valid actor of signer (buyer)|
|fee|Yes|Positive number less than 10000000000|Flat fee in FIO taken up front for listing a domain for sale|
|max_fee|Yes|Positive Int|Maximum amount of SUFs the user is willing to pay for fee. Should be preceded by [/get_fee](https://developers.fioprotocol.io/api/api-spec/reference/get-fee/get-fee) for correct value.|
|tpid|Yes|FIO Address|FIO Address of the entity which generates this transaction. TPID rewards will be paid to this address. Set to empty if not known.|

##### Example
```
{
    "actor": "2odzomo2v4pe",
    "fee": "3000000000",
    "max_fee": 1000000000,
    "tpid": "rewards@wallet"
}
```
#### Processing
- Request is validated per exception handling
- Find marketplace
- Modify listing fee
- Verify that the fee for this does not exceed the max fee specified.
- Charge appropriate fee (this will be a bundled fee transaction, fee will be same as reject)
- Verify tx does not exceed max transaction size.

#### Exception handling
|Error condition|Trigger|Type|fields:name|fields:value|Error message|
|---|---|---|---|---|---|
|Invalid marketplace|Supplied `marketplace` is not found in marketplace config table `mrkplconfig`|400|"marketplace"|Value sent in, e.g. "notamarketplace"|"Marketplace not found"|
|Invalid listing fee|`fee` is not between 0-10|400|"fee"|Value sent in, e.g. "20" |"Listing fee can only be between 0 and 10"|
|Invalid fee value|max_fee format is not valid|400|"max_fee"|Value sent in, e.g. "-100"|"Invalid fee value"|
|Fee exceeds maximum|Actual fee is greater than supplied max_fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Fee exceeds supplied maximum"|
|Insufficient funds to cover fee|Account does not have enough funds to cover fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Insufficient funds to cover fee"|
|Invalid TPID|tpid format is not valid|400|"tpid"|Value sent in, e.g. "notvalidfioaddress"|"TPID must be empty or valid FIO address"|
|Actor not signer|The signer and the `actor` do not match |403| | |Type: invalid_signature|
|Not owner of marketplace|The signer does not own the marketplace|403| | | |

#### Response body
|Parameter|Format|Definition|
|---|---|---|
|status|String|OK if successful|
|new_listing_fee|int|New listing fee amount, in SUFs| 
|fee_collected|Int|Amount of SUFs collected as fee|

##### Example
```
{
  "status": "OK",
  "fee_collected": 2000000000
}
```

### Set E-Break
#### Contract: fio.escrow
#### New fee: set_marketplace_e_break, not bundle eligible
#### New Endpoint: set_marketplace_e_break
#### Ram Increase: To be determined during implementation
#### New action: *setmkpebreak*
This will toggle the e-break on or off. It can only be executed by the marketplace or an msig

#### Request
|Parameter|Required|Format|Definition|
|---|---|---|---|
|actor|Yes|12 character string|Valid actor of signer (buyer)|
|max_fee|Yes|Positive Int|Maximum amount of SUFs the user is willing to pay for fee. Should be preceded by [/get_fee](https://developers.fioprotocol.io/api/api-spec/reference/get-fee/get-fee) for correct value.|
|tpid|Yes|FIO Address|FIO Address of the entity which generates this transaction. TPID rewards will be paid to this address. Set to empty if not known.|

##### Example
```
{
    "actor": "2odzomo2v4pe",
    "max_fee": 1000000000,
    "tpid": "rewards@wallet"
}
```
#### Processing
- Request is validated per exception handling
- Find marketplace
- Verify the actor is the owner of the marketplace
- Toggle the e_break field to either 1 or 0, whichever the opposite of what the current value is.

#### Exception handling
|Error condition|Trigger|Type|fields:name|fields:value|Error message|
|---|---|---|---|---|---|
|Not owner of marketplace|The signer does not own the marketplace|403| | | |
|Fee exceeds maximum|Actual fee is greater than supplied max_fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Fee exceeds supplied maximum"|
|Insufficient funds to cover fee|Account does not have enough funds to cover fee|400|"max_fee"|Value sent in, e.g. "1000000000"|"Insufficient funds to cover fee"|
|Invalid TPID|tpid format is not valid|400|"tpid"|Value sent in, e.g. "notvalidfioaddress"|"TPID must be empty or valid FIO address"|
|Actor not signer|The signer and the `actor` do not match |403| | |Type: invalid_signature|

#### Response body
|Parameter|Format|Definition|
|---|---|---|
|status|String|OK if successful|
|new_listing_fee|int|New listing fee amount, in SUFs| 
|fee_collected|Int|Amount of SUFs collected as fee|

##### Example
```
{
  "status": "OK",
  "fee_collected": 2000000000
}
```

## Modified actions
#### Contract: fio.token
#### Modified Action: transfer

- Added the following code to `fio.token::transfer` so that, from the fio.escrow contract, it can transfer tokens from two accounts.
```c++
if (from != SYSTEMACCOUNT && from != TREASURYACCOUNT && from != EscrowContract) {
    if(!has_auth(EscrowContract)){
        check(to == TREASURYACCOUNT, "transfer not allowed");
    }
}
eosio_assert((has_auth(SYSTEMACCOUNT) || has_auth(TREASURYACCOUNT) || has_auth(EscrowContract)),
             "missing required authority of treasury or eosio");
```

Note: I added a `&& from != EscrowContract` and then wrapped the `check()` to see if the caller `!has_auth(EscrowContract)`.

#### Contract: fio.address
#### Modified Action: burnexpired
This action needs to be updated because there is no expiration to a domain being listed. If a domain is expired and still listed, when it is going to be burned it needs to also be removed as a listing for sale.

#### Added Processing
- Look up domain that is being burned in the `domainsales` table
- If found, remove the entry from `domainsales`

```c++
    for (int i = 0; i < domainburnlist.size(); i++) {
        const uint128_t burner = domainburnlist[i];

        auto domainsbyname = domains.get_index<"byname"_n>();
        auto domainsiter = domainsbyname.find(burner);

        if (domainsiter != domainsbyname.end()) {
            domainsbyname.erase(domainsiter);
        }

        // ADDED
        // Find any domains listed for sale on the fio.escrow contract table
        auto domainsalesbydomain = domainsales.get_index<"bydomain"_n>();
        auto domainsaleiter = domainsalesbydomain.find(burner)
        // if found, erase the entry
        if(domainsaleiter != domainsalesbydomain.end()){
            domainsalesbydomain.erase(domainsaleiter)
        }
        // END ADDED
    }
```

#### Added action to existing contract

- `fio.address::xferescrow` has been added to facilitate the transferring of domains between two accounts. This action is only available when called from `fio.escrow`.

#### Contract: fio.address
#### New fee: none, covered by the fio.escrow action that calls this one.
#### Ram Increase: To be determined during implementation
#### New action: *xferescrow*

This is an action added to the `fio.address` contract specifically for the fio.escrow contract. Only the `EscrowContract` can call this action.

This action facilitates transferring the domain for sale to the holder account and back to the seller in the case of a cancel. In the case of a sale it transfers to the buyer.

#### Request
|Parameter|Required|Format|Definition|
|---|---|---|---|
|fio_domain|Yes|FIO domain name|valid, registered, unexpired domain|
|public_key|Yes|FIO public key|Valid FIO Domain that is already listed|
|actor|Yes|FIO Domain|Valid FIO Domain that is already listed|

##### Example

#### Processing
- Request is validated per exception handling
- Find domain
- Update account value  

#### Exception handling
|Error condition|Trigger|Type|fields:name|fields:value|Error message|
|---|---|---|---|---|---|
|Invalid marketplace|Supplied `marketplace` is not found in marketplace config table `mrkplconfig`|400|"marketplace"|Value sent in, e.g. "notamarketplace"|"Marketplace not found"|
|Insufficient Funds|`buyer` doesn't have enough funds|400| | |"Not enough FIO"|
|Invalid FIO Domain format|FIO Domain format is not valid|400|"fio_domain"|Value sent in, e.g. "alice"|"Invalid FIO domain"|
|FIO Domain expired|FIO Domain is expired|400|"fio_domain"|Value sent in, e.g. "alice"|"FIO Domain expired. Renew first."|
|FIO Domain not registered|FIO Domain is not registered|400|"fio_domain"|Value sent in, e.g. "alice"|"FIO Domain not registered"|
|Not owner of FIO Domain|The signer does not own the domain|403||||
|Actor not signer|The signer and the `actor` do not match |403| | |Type: invalid_signature|

#### Response
none, inline action

##### Example
none

# Rationale
* We may not need api end-points for our actions so none are included in this document, as of right now
* **Domain Transfers** - We feel that having the ownership of the domain transferred to a holder account is necessary because it makes sure that when a buyer comes along that it is 100% available for sale. If the ownership doesn't transfer then the seller can still use the domain until it sells, and then, if a buyer comes along it might suddenly, without notice, disappear from their account.
* Any section that is blank will be filled out in the future as we get further along in the process

# Backwards Compatibility
TBD

# Future considerations
* Functionality for addresses
* Being able to renew a domain upon purchase
* Messaging system
* Expiring domain page to see all domains that are about to expire
* For the frontend to facilitate the registering of usernames to domains
* Being able to send an offer to the seller and they can either accept or decline
* “Willing to sell” designation
* Being able to send and receive FIO

# Discussion links
* Project Documentation - https://fioprotocol.atlassian.net/l/c/ddpA8xJb
* Fee/Commission Structure Discussion - https://fioprotocol.atlassian.net/l/c/XN5rbhK0
* Marketplace Fee/Commission Documentation - https://fioprotocol.atlassian.net/l/c/P65fQTqg
